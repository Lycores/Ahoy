## 小技巧

### 如何事件传参

柯里化，高级函数

### 如何避开 CORS

setUpProxy

### 当父组件有事件需要获得子组件节点，但是子组件无法使用 ref 怎么办？

使用 forwardRef （这里可以继续展开）

### 传参方式

可以用 state from location, useLocation hooks

## 遇到的问题

#### 我在做折叠卡片的时候，因为要 watch 很多卡片的状态，那么对应的事件函数也很多，我使用工厂模式放到一个函数里，用 switch 分割，但还是太多，于是我想到使用新 syntax，就是 Variable[string]的方式，工厂模式的时候传入的 string 不再用在 switch 上，而是直接通过拼接成为 object key 或者 parameter. 这里遇到一个问题就是，我看到一些文章说，object key 和它的 string 格式是等价的，其实不等价，他们打印出来一样但其实不一样，所以如果一个 string 想要当 key,需要加[]成为[Computed property names](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Object_initializer#computed_property_names)

Play with Spotify API  的问题，因为是 async 请求，导致有些东西是空的，比如页面加载会自动请求，但是里面的 attributes 却是空的，因为 attributes 还没从服务器返回，比如说 access_token

## 粗心的问题

大量比较粗心的问题暴露在 api 调试上，打个比方，我先做了 getsavedalbum 这个功能，我发现它返回的 json 有完整的 track 信息，我一开始在请求让 player 播放的时候一直失败，后来我发现有一个叫 position 的信息是需要填的（但是 API 文档没有重点标识），这个 postion 指的是 track 在 album 中的 index,所以想要给出 track id 让 player 播放是一件不可能的事情。后来我做了 getTopTrack 这个功能，但是 getTopTrack 这个功能返回的 track 没有他在 album 中的 position 这个信息，我想完了，我要请求十次 album 的信息才行。但是我如果连续 async 请求十次，服务器直接把我当 ddos 攻击了，后来我找到一个 api，是一次请求获得多个 album。不过后来我又发现，track 里有一个叫 track number 的东西，它就是 position，但是我怎么试服务器都给 403，我最后发现的原因是，position 是 0 开头，track number 是 1 开头，我误以为 track number 也是 0 开头的，然后我测试的 track 正好是专辑的最后一张这导致我给服务器的 position 一直是 out of range

player button onClick 直接叫了函数没有给函数指针，导致 back, next, pause 在来回换，因为他们都被 call 了。音乐卡死了

## 设计模式

##### 首先在主页的卡片我们要追踪很多很多的卡片，那就有很多 state 需要更新，那就要放置很多的 clickHandler, 那就有很多 function。首先我们通过工厂模式集中更新 state. 但是我发现使用简单的工厂模式依然有很长的 switch, 后来我追加了一个工厂模式，通过 拼接注入的名字和某个字符串生成 object 的 key，再使用 es6 syntax computed property names, 使用一个 function 就替代了超长的代码

## 设计经验

（存疑）CSS layout 设计应该以谁最重要，谁定义谁的尺寸就应该先被编写 CSS。这是一种自下而上的设计。比如我想定义一个音乐播放器，而上方是一些 playlist，他们竖直放在一个 container 里，我要求它在某个尺寸以下变为 fixed 的小播放器，这个时候 player 拥有更高的优先级。它应该先被定义。也就是说，player 的尺寸先于 container 的尺寸被设计， 说到底，就是是先设计小部件的尺寸，再让宽高自己适应，还是先设计宽高，再设计小部件

设计的时候要避免 watch 不必要的 state, 比如，onclick 的时候，如果发生对象和作用对象一致，不需要用 useRef， 直接 event.target 就可以。有时候为了方便调整 layout 我通常会设计很多 global 变量，做到修改一处代码整个 layout 修改。这个，与 responsive page 是不同的，只有当尺寸改变需要相应才需要 useState

## 路程

一开始只是想制作一个 home assistance， 做完了 card 的 transition 之后我的野心变大了，想要做一个 music player 带响应式的， 所以制作了 top bar 并且达到了响应式，然后开始制作 playlist 页面在成功让 spotify 在我的页面运行之后我就觉得这个更像一个音乐播放器. 而且以前的 home assistance 感觉开始有点无聊 所以我在想怎么运用卡片这个废弃资产.在开发了 album 和 artist 页面后，我发现 album page 和 artist page 在左侧的重合率太高了，所以我一想这不就是 navbar 吗，所以我把左侧 component 独立出来然后用 nested router 和 outlet 只刷新右侧，这让 player 的状态贯穿所有页面，player 每次刷新都需要重新加载 j s 重新请求 device id,这样独立出来就不会被刷新。然后呢我发现很多组件很没必要地刷新，我想要 usememo 解决这个问题

然后呢我又发现 nexted component 太多了，一个 token 要穿越五六层 component,可以考虑

## 优化：

在设计响应式页面我制作了大量的 global length 来确保每个部件行为一致，同样的，即使部分代码使用 css 我也希望提高复用性，所以我引入 sass

然后我开始发现页面有些卡了，之前都是用 display none 的，不能用了，我用 react router 按需要加载

后来发现使用 route 的话，左侧的 player 会不停地加载，因为这个事从 spotify 网站动态插入 code 的，也就是每次 player 组件加载，就会请求 player 对象。所以我把整个左侧栏全部变成 navBar, 利用 react router 的组件式路由特性，把 navBar 隔离在路由之外

## Spotify 的 OAuth 是如何工作的

## 优化需求

album 页面和其他页面有一些不同， 因为得到的 album object 拥有完整的 track 信息，所以我不再需要进行请求，

artist 页面需要进行请求

flex 布局的时候没有设置 grow 属性导致页面即使只有两个元素也无法横向充满，只能保持子元素填充的宽度，宽度失效

只用 css 制作 responsive 的正方形很难，需要用 js

z-index 的知识点

错误:想要播放音乐需要 position 才可以

细节：Searcher 强制取消聚焦

确保 deviceId 准备好了再渲染

问题发现，每次刷新的时候都会重新请求 deviceId,超级多的请求 而且用户不停切换的时候太快导致请求的新的 device_id 还没到，那就无法播放会出错

## HighLight:

stop player refresh

fully responsive

遇到的问题，我发现 album page 和 artist page 在左侧的重合率太高了，所以我一想这不就是 navbar 吗，所以我把左侧 component 独立出来然后用 nested router 和 outlet 只刷新右侧，这让 player 的状态贯穿所有页面，player 每次刷新都需要重新加载 j s 重新请求 device id, 遇到的问题，因为是 nested url,打个比方以前是/album /artist, 现在要先进入/traditional 装配左侧组件，再根据右侧 router 装配，所以是/traditional/album 这样，我需要把大量的共用代码拆分放到/traditional 对应的组件里面，在这个时候，我没意识到我的 proxy 和 server 也要加/traditional，所以花了很多时间在上面.同时，有的请求是在/下请求的就不需要/traditional

然后我发现一直使用 props 太烦了，所以我使用 recoil

状态控制，传播与 async 函数的问题： 我们要让 useEffect 只在必要的时候运行，同时 setState 保证一要在必要的时候重新渲染。打个比方我们有很多个 async 函数，。。。

不同的写法对比，如果用 async/await 写法，变量值会以 null 先返回，如果在.then()中等待可能更好

大坑： setState 不更新的原因：例子，我有一个 array 是 async 得来的 album： 渲染不会等待数组我承认，我准备了 default case, 然后我发现，得到数组之后 update,居然，不 rerender, 后来我发现，setstate 只是欠监听，要变化被发现，需要用三点表达式

需要的思考？我使用 react.memo 用来防止重复的渲染，但是我又觉得数据流太长了，我想要 recoil，但是 recoil 破坏了 props， 那么 react.memo 就无效了，我得选出一个东西来决定这个渲染是否是是无效的，其他的东西放入 recoil

## Optimization:

验证这件事放到 welcome page 去

还有一些其他需要考虑的地方，打个比方我在‘/’页面就开始向服务器请求数据了，但是万一一直不点，就超时了

所以需要移动到 welcome page 等待按下按钮再去 fetch 安全一点

出现问题: 我想要去渲染一个音乐列表但是列表就是渲染不出来虽然数据对的。原因就是 async 拿到数据之前就渲染了，然后拿到数据之后没有重新渲染，导致列表一直是空的

setState 和 useEffect 的想法，如果有有一个列表需要一秒渲染。渲染后我拿到值，那我是不是要再次 setState,那我会再次去拿值，再次重新渲染无限循环

如何理解不要再渲染的时候 setstate?

i need to write something

文字排版上遇到的困难。

从 css in js 迁移到 styled component

确保宽度高度在一个 ratio 同时还是 dynamically scaled

recoil 无法在刷新的时候继续保持 state

尝试使用 HOC，但是 HOC 无法应用于函数式组件，报错和 hook 有关，我看了网上很多资料，都是用类式组件

小知识：如果你在一个 then 函数里先 let a = xxx.json(), 再 console.log(a) 对不起，a 依然是 promise, 你需要在下一个 then 里作这件事

搜索框：搜索框混用了 setTimeout 和 abortcontroller, 目的在于改进 abortcontroller 的问题。原来的想法是，当用户不断 on change，我不断 abort 之前的 request，但是问题在于这给了服务器更大的压力，所以我使用了 useTimeout 和 abortcontroller 结合，在一段时间之后再 abort 之前的 request 再发送，这也有助于 abort request 在一个非常极端的网络环境下

如何实现 search page top result 功能。flex-grow 都为 1，

在 flex 换行前通常我们要求两个元素有空隙，在换行后我们又要求这个空隙的 css 消失。最好的办法不是使用 margin 而是对 flex 父元素使用 gap

flex 时候设置自动换行，下面有东西拒绝换行怎么办

响应式里最难的是什么？最难的是用 flex/grid 的情况下进行一个好的响应式体验。假设我用 flex 去均分一个宽度，那么各个元素是不知道自己的宽度的，如果在某个元素里有需要使用 overflow scroll 的东西的时候就蒙了，父元素的宽度是 flex 决定的，而父元素的最小宽度是子元素的最小宽度，也就是说父元素无法小于子元素，没有 scrollbar 出现

## 最大的困难：

##### 结论：最大的困难就是在 flex 布局下的智能 sizing，智能 typography 的同时保证不出现任何 overflow 的同时让页面看起来好看。

##### 阶段 1: 问题的发现：（视频）如图，左封面和右边的 text 都属于 flex item，左边的封面是由 clamp(px, vw, px）定义的)， 右边的 font-size 同样是由 clamp(px, vw, px)定义的。问题在于，一开始画面的 content 没有 overflow,之后就 overflow 了，为什么？

##### 阶段 1: 问题的解答：如果不显性表达，flex item 的 width 是失效的的。打个比方，我们都知道 overflow 发生的条件是父元素宽度比子元素低，假设这个情况，如果父元素是 flex 的 item，并且这个父元素有一个子元素，子元素是固定的宽度，我们希望通过减小窗口宽度来减小父元素的宽度从而让子元素宽度大于父元素，这是不可能实现的，整个页面会 overflow 而不是父元素 overflow,因为父元素的宽度的最小值是子元素的宽度，overflow 永远不会发生。如果我们希望而在响应式里面显性表达宽度意味着要一直使用 JS 进行计算并且重复渲染。flex item 的 width 完全由它孩子的宽度决定，然而在视频里，clamp 是一个智能的 css 表达式，我们无法精确控制它的宽度，所以它孩子的宽度撑起父亲的宽度，当我们继续减少 window width,自然会出现 content overflow

##### 阶段 2: 问题的发现: 当我发现使用 CSS 很难解决上述问题的时候，我决定使用 JS 去解决这个问题，我使用减法获得 text 可以伸展的最大宽度并且应用在 style 上，然而我发现了另一个问题：cover 的尺寸不动了

##### 阶段 2: 问题的解答：cover 的尺寸不动的原因是因为我们一直维护着 text 的宽度， clamp 感受不到压力就不会减少 width,也就是说，想要让 cover 的宽度动态变化只用 js 是行不通的。

##### 阶段 3: 问题的发现: 可以发现，一开始 clamp 的工作是很好的然而它的表现越来越糟糕，其中有两个原因：第一个原因是作为 cover，我们不能让它的尺寸变得很小，所以 cover 的变化有限，限制了 text 的空间。第二是左侧的 navbar 的尺寸是不变的，所以天然上的讲，text 的空闲宽度也会越来越小。

##### 阶段 3: 问题的解答：为了应对这个问题我决定为 cover width 设置一个 breakpoint, 当 cover 尺寸小于 breakpoint 的时候，JS 才开始介入, 这样做的好处在于，当 text 很长的时候，这个时候图片 size 的 state 处于 和 vw 成比例的状态，也就是持续缩小，同时 text 的 width 被 js 控制也在缩小。当 text 很短的时候，我们就晚点使用 js 操控,clamp 这个时候完全够用。同时我做了一系列优化，比如当 text 很长的时候稍微减小 font-size，页面 responsive 的情况变得可以接受了（视频）同时这个页面也需要关注下如果下方的 track 名字太长需要对 text 进行 overflow

##### 阶段 4: 问题的发现: 我发现有一个 album 出现了这个问题(视频)，我认为原因在于 clamp 比较智能，一开始这个 cover size 一开始就比较小，所以传入了冲破了 breakpoint，导致整个开始使用 js 控制，当用 js 限制 text 宽度的时候，它又觉得压力变小了，所以尺寸变大，然而 css 不会 re-render，这就导致 text 一直处于 js 的控制之中，并且宽度多了 (图片大的尺寸-图片小的尺寸)/2 。当 js 触发之后，图片 width 不再感受到压力，所以变成了大图片，然而重要的是，这个不会触发 re-render.

##### 阶段 4: 问题的解答：解决这个问题的方法我尝试了很多，可是都比较失败，根本原因不是非常清楚，不过看这个视频，我认为原因是当图片变小的时候我们使用 js 控制尺寸，这个时候图片 width 感觉压力减小，尺寸重新增大，增大之后 text 的 js 放开，导致图片压力增大，开始变小，变成一个循环。所以我最终的解决办法是根据 text 长度来选择 cover 大小，这从根本上阻止了 cover 变大。

##### 结果:(视频)， 同时也告诉我虽然 clamp 很好但是有些时候很难控制
